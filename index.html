<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>BeerFinder ‚Äî Carte & √Ä proximit√©</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <script
    defer
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <style>
    :root{
      --bg:#0f1115; --card:#151922; --muted:#98a2b3; --text:#e6e7ea; --accent:#42b883;
      --danger:#ef4444; --warn:#f59e0b; --good:#10b981; --border:#222635;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      background:var(--bg); color:var(--text);
    }
    header{
      position:sticky; top:0; z-index:20; backdrop-filter: blur(6px);
      background:linear-gradient(180deg, rgba(15,17,21,.9), rgba(15,17,21,.65));
      border-bottom:1px solid var(--border);
    }
    .container{max-width:1100px; margin:0 auto; padding:12px 16px;}
    h1{margin:4px 0 10px 0; font-size:20px; letter-spacing:.3px}
    .filters{
      display:flex; flex-wrap:wrap; gap:10px; align-items:center; padding:10px 0 8px;
    }
    .filters .chip{
      background:var(--card); border:1px solid var(--border); border-radius:10px;
      padding:8px 10px; display:flex; gap:8px; align-items:center;
    }
    .filters button{
      background:var(--accent); color:#0b1020; border:none; border-radius:10px; cursor:pointer;
      padding:10px 12px; font-weight:600; transition: transform .05s ease;
    }
    .filters button:active{ transform: translateY(1px) }
    .filters .ghost{
      background:transparent; color:var(--text); border:1px solid var(--border);
    }
    .filters label{font-size:13px; color:var(--muted)}
    .filters input[type="range"]{ width:160px }
    .status{
      font-size:13px; color:var(--muted); padding:4px 0 10px;
      min-height:20px; /* anti-jump */
    }

    main{ display:grid; grid-template-columns: 1.2fr .8fr; gap:14px; padding:14px 16px; }
    #map{ width:100%; height:65vh; border-radius:14px; border:1px solid var(--border); }
    .panel{
      background:var(--card); border:1px solid var(--border); border-radius:14px; padding:12px;
      display:flex; flex-direction:column; gap:8px; min-height:65vh;
    }
    .panel h2{font-size:16px; margin:0 0 4px}
    .list{ display:flex; flex-direction:column; gap:8px; overflow:auto; }
    .card{
      border:1px solid var(--border); background:#0d111a; border-radius:12px; padding:10px;
    }
    .card .row{ display:flex; justify-content:space-between; gap:10px; align-items:center;}
    .pill{ font-size:12px; padding:3px 8px; border-radius:999px; border:1px solid var(--border); color:var(--muted)}
    .distance{ font-weight:700; }
    .muted{ color:var(--muted); font-size:13px}
    .msg{ padding:10px 12px; border-radius:10px; font-size:14px;}
    .msg.ok{ background: rgba(16,185,129,.12); border:1px solid rgba(16,185,129,.3); }
    .msg.warn{ background: rgba(245,158,11,.12); border:1px solid rgba(245,158,11,.3); }
    .msg.err{ background: rgba(239,68,68,.12); border:1px solid rgba(239,68,68,.3); }

    /* Contr√¥le flottant Leaflet (bouton Localiser) */
    .leaflet-control.locate{
      background:var(--card); border:1px solid var(--border); padding:6px; border-radius:10px;
      box-shadow: 0 6px 16px rgba(0,0,0,.25);
    }
    .leaflet-control.locate button{
      background:var(--accent); color:#0b1020; border:none; border-radius:8px; cursor:pointer;
      padding:8px 10px; font-weight:700;
    }

    @media (max-width: 900px){
      main{ grid-template-columns: 1fr; }
      #map{ height:56vh }
    }
  </style>
</head>
<body>
  <header>
    <div class="container">
      <h1>üç∫ BeerFinder ‚Äî Carte & √Ä proximit√©</h1>

      <!-- Barre de filtres -->
      <div class="filters" role="region" aria-label="Filtres de recherche">
        <div class="chip">
          <input type="checkbox" id="toggleNearby" />
          <label for="toggleNearby">√Ä proximit√©</label>
        </div>

        <div class="chip">
          <label for="radius">Rayon&nbsp;<span id="radiusLabel">2.0</span>&nbsp;km</label>
          <input type="range" id="radius" min="0.5" max="10" step="0.5" value="2"/>
        </div>

        <button id="btnLocate" class="ghost" title="Me localiser">üìç Localiser</button>

        <button id="btnReset" class="ghost" title="Effacer la localisation">R√©initialiser</button>
      </div>

      <div id="status" class="status" aria-live="polite"></div>
    </div>
  </header>

  <main class="container">
    <div id="map" aria-label="Carte des pubs et bi√®res"></div>

    <aside class="panel" aria-label="R√©sultats">
      <h2>R√©sultats <span class="muted">(tri√©s par distance si localis√©)</span></h2>
      <div id="results" class="list" role="list"></div>
    </aside>
  </main>

  <script>
    // ---------------------------
    // D√âMO: donn√©es statiques
    // Remplacera plus tard par Supabase (pubs, bi√®res, etc.)
    // ---------------------------
    const PUBS_DEMO = [
      { id: "p1", name: "Le Houblon Joyeux", city:"Paris 3",   lat:48.8646, lng:2.3522, price:"‚Ç¨‚Ç¨", tags:["craft","ipa"] },
      { id: "p2", name: "La Capsule",        city:"Paris 10",  lat:48.8757, lng:2.3570, price:"‚Ç¨‚Ç¨", tags:["belge","trappiste"] },
      { id: "p3", name: "Mikkeller Bar",     city:"Paris 9",   lat:48.8765, lng:2.3361, price:"‚Ç¨‚Ç¨‚Ç¨", tags:["craft","sour"] },
      { id: "p4", name: "Brewdog",           city:"Paris 2",   lat:48.8673, lng:2.3429, price:"‚Ç¨‚Ç¨‚Ç¨", tags:["craft","ipa"] },
      { id: "p5", name: "Paname Brewing",    city:"Paris 19",  lat:48.8867, lng:2.3738, price:"‚Ç¨‚Ç¨", tags:["brewpub","lager"] },
    ];

    // ---------------------------
    // √âTAT (persistance locale)
    // ---------------------------
    const LS_KEYS = {
      RADIUS: "beerfinder.radiusKm",
      NEARBY: "beerfinder.nearby",
      LOC: "beerfinder.lastLocation", // {lat,lng,ts}
    };

    const els = {
      status: document.getElementById('status'),
      results: document.getElementById('results'),
      radius: document.getElementById('radius'),
      radiusLabel: document.getElementById('radiusLabel'),
      toggleNearby: document.getElementById('toggleNearby'),
      btnLocate: document.getElementById('btnLocate'),
      btnReset: document.getElementById('btnReset'),
      map: document.getElementById('map'),
    };

    // Charger pr√©f√©rences
    const initRadius = parseFloat(localStorage.getItem(LS_KEYS.RADIUS) || "2");
    const initNearby = localStorage.getItem(LS_KEYS.NEARBY) === "true";
    els.radius.value = isFinite(initRadius) ? initRadius : 2;
    els.radiusLabel.textContent = Number(els.radius.value).toFixed(1);
    els.toggleNearby.checked = initNearby;

    // ---------------------------
    // CARTE
    // ---------------------------
    const map = L.map('map', {
      zoomControl: true,
      minZoom: 2,
      worldCopyJump: true,
    }).setView([48.8566, 2.3522], 12); // Paris par d√©faut

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap'
    }).addTo(map);

    // Contr√¥le flottant "Localiser"
    const LocateControl = L.Control.extend({
      onAdd: function() {
        const div = L.DomUtil.create('div', 'leaflet-control locate');
        const btn = L.DomUtil.create('button', '', div);
        btn.type = 'button';
        btn.textContent = 'üìç Localiser';
        btn.title = 'Me localiser';
        btn.addEventListener('click', () => handleLocate());
        return div;
      },
      onRemove(){},
      options: { position: 'bottomright' }
    });
    map.addControl(new LocateControl());

    // Calques
    const layerPubs = L.layerGroup().addTo(map);
    let userMarker = null;
    let userCircle = null;

    // ---------------------------
    // MARQUEURS PUBS
    // ---------------------------
    const markerIndex = new Map(); // id -> marker
    function renderPubs(pubs){
      layerPubs.clearLayers();
      markerIndex.clear();
      pubs.forEach(p => {
        const m = L.marker([p.lat, p.lng]).addTo(layerPubs)
          .bindPopup(`<strong>${escapeHtml(p.name)}</strong><br/><span class="muted">${escapeHtml(p.city)}</span><br/>${p.price} ‚Äî ${p.tags.map(t=>`<span class="pill">${escapeHtml(t)}</span>`).join(' ')}`);
        markerIndex.set(p.id, m);
      });
    }
    renderPubs(PUBS_DEMO);

    // ---------------------------
    // LISTE & TRI PAR DISTANCE
    // ---------------------------
    function computeDistanceMeters(a, b){
      return L.latLng(a.lat, a.lng).distanceTo(L.latLng(b.lat, b.lng));
    }

    function updateList(userLoc){
      const nearbyOn = els.toggleNearby.checked;
      const radiusKm  = Number(els.radius.value);
      const radiusM   = radiusKm * 1000;

      const enriched = PUBS_DEMO.map(p => {
        let dist = null;
        if(userLoc){
          dist = computeDistanceMeters({lat:p.lat,lng:p.lng}, userLoc);
        }
        return {...p, distance: dist};
      });

      let filtered = enriched;
      if(nearbyOn && userLoc){
        filtered = enriched.filter(p => p.distance !== null && p.distance <= radiusM);
      }

      // Trier : si userLoc pr√©sent => par distance, sinon par nom
      filtered.sort((a,b) => {
        if(userLoc){
          return (a.distance??Infinity) - (b.distance??Infinity);
        }
        return a.name.localeCompare(b.name);
      });

      // Affichage liste
      els.results.innerHTML = '';
      if(filtered.length === 0){
        const div = document.createElement('div');
        div.className = 'msg warn';
        div.textContent = nearbyOn && userLoc
          ? `Aucun r√©sultat dans ${radiusKm.toFixed(1)} km.`
          : `Aucun r√©sultat.`;
        els.results.appendChild(div);
      }else{
        for(const p of filtered){
          const item = document.createElement('div');
          item.className = 'card';
          const distStr = p.distance != null ? (p.distance/1000).toFixed(2) + ' km' : '‚Äî';
          item.innerHTML = `
            <div class="row">
              <div>
                <div><strong>${escapeHtml(p.name)}</strong></div>
                <div class="muted">${escapeHtml(p.city)} ‚Ä¢ ${escapeHtml(p.price)} ‚Ä¢ ${p.tags.map(t=>`<span class="pill">${escapeHtml(t)}</span>`).join(' ')}</div>
              </div>
              <div class="distance">${distStr}</div>
            </div>
          `;
          item.addEventListener('click', () => {
            const m = markerIndex.get(p.id);
            if(m){
              map.setView(m.getLatLng(), Math.max(map.getZoom(), 14), {animate:true});
              m.openPopup();
            }
          });
          els.results.appendChild(item);
        }
      }

      // Cacher/montrer marqueurs si mode √Ä proximit√© actif
      layerPubs.eachLayer(mk => {
        mk.addTo(layerPubs); // no-op si d√©j√†
        if(nearbyOn && userLoc){
          const latlng = mk.getLatLng();
          const d = L.latLng(latlng.lat, latlng.lng).distanceTo(L.latLng(userLoc.lat, userLoc.lng));
          if(d > radiusM){
            layerPubs.removeLayer(mk);
          }
        }
      });
    }

    // ---------------------------
    // G√âOLOCALISATION
    // ---------------------------
    function setStatus(html, kind=''){
      els.status.innerHTML = html;
      els.status.className = 'status ' + (kind ? `msg ${kind}` : '');
    }

    function clearUserLocation(){
      if(userMarker){ map.removeLayer(userMarker); userMarker = null; }
      if(userCircle){ map.removeLayer(userCircle); userCircle = null; }
    }

    function applyUserLocation(lat, lng, accuracy){
      clearUserLocation();
      userMarker = L.marker([lat,lng], {title:'Votre position'}).addTo(map).bindPopup('Vous √™tes ici');
      const radius = Math.max(accuracy||50, 20);
      userCircle = L.circle([lat,lng], {radius, color:'#42b883', fillColor:'#42b883', fillOpacity:.15}).addTo(map);
    }

    function saveUserLocation(lat,lng){
      localStorage.setItem(LS_KEYS.LOC, JSON.stringify({lat,lng,ts:Date.now()}));
    }
    function loadUserLocation(){
      try{
        const raw = localStorage.getItem(LS_KEYS.LOC);
        if(!raw) return null;
        const obj = JSON.parse(raw);
        if(obj && typeof obj.lat==='number' && typeof obj.lng==='number') return obj;
      }catch{}
      return null;
    }

    async function handleLocate(){
      if(!('geolocation' in navigator)){
        setStatus('‚ùå G√©olocalisation non support√©e par ce navigateur.', 'err');
        return;
      }
      setStatus('üìç Localisation en cours‚Ä¶', 'ok');
      navigator.geolocation.getCurrentPosition(
        pos => {
          const { latitude:lat, longitude:lng, accuracy } = pos.coords;
          applyUserLocation(lat, lng, accuracy);
          saveUserLocation(lat, lng);
          setStatus(`‚úÖ Localis√© (¬±${Math.round(accuracy||50)} m).`, 'ok');
          // Ajuster vue
          const nearbyOn = els.toggleNearby.checked;
          const r = Number(els.radius.value) * 1000;
          if(nearbyOn){
            map.setView([lat,lng], 15);
          }else{
            // vue qui inclut le cercle et quelques pubs
            map.setView([lat,lng], 14);
          }
          updateList({lat,lng});
        },
        err => {
          if(err.code === err.PERMISSION_DENIED){
            setStatus('üö´ Permission refus√©e. Active ‚Äú√Ä proximit√©‚Äù seulement avec une localisation.', 'warn');
          }else if(err.code === err.POSITION_UNAVAILABLE){
            setStatus('‚ö†Ô∏è Position indisponible. R√©essaie plus tard.', 'warn');
          }else if(err.code === err.TIMEOUT){
            setStatus('‚è≥ D√©lai d√©pass√© pour obtenir la position.', 'warn');
          }else{
            setStatus('‚ùå Erreur inconnue de g√©olocalisation.', 'err');
          }
        },
        { enableHighAccuracy:true, timeout:10000, maximumAge:0 }
      );
    }

    // ---------------------------
    // √âV√àNEMENTS UI
    // ---------------------------
    els.radius.addEventListener('input', () => {
      const v = Number(els.radius.value);
      els.radiusLabel.textContent = v.toFixed(1);
      localStorage.setItem(LS_KEYS.RADIUS, String(v));
      const loc = getCurrentUserLoc();
      updateList(loc);
    });

    els.toggleNearby.addEventListener('change', () => {
      localStorage.setItem(LS_KEYS.NEARBY, String(els.toggleNearby.checked));
      const loc = getCurrentUserLoc(true);
      if(els.toggleNearby.checked && !loc){
        setStatus('‚ÑπÔ∏è Active ‚ÄúLocaliser‚Äù pour filtrer √† proximit√©.', 'warn');
      }else{
        setStatus('');
      }
      updateList(loc);
    });

    els.btnLocate.addEventListener('click', () => handleLocate());

    els.btnReset.addEventListener('click', () => {
      localStorage.removeItem(LS_KEYS.LOC);
      clearUserLocation();
      setStatus('üîÑ Localisation effac√©e. Mode carte g√©n√©rale.', '');
      updateList(null);
    });

    function getCurrentUserLoc(fromStorage=true){
      if(userMarker){
        const ll = userMarker.getLatLng();
        return {lat: ll.lat, lng: ll.lng};
      }
      if(fromStorage){
        return loadUserLocation();
      }
      return null;
    }

    // ---------------------------
    // D√âMARRAGE
    // ---------------------------
    (function boot(){
      // Si on a une localisation m√©moris√©e, l'afficher
      const saved = loadUserLocation();
      if(saved){
        applyUserLocation(saved.lat, saved.lng, 50);
        // Ne pas forcer le recentrage si l‚Äôutilisateur veut regarder ailleurs
      }
      // Peupler la liste initiale
      updateList(saved || null);
    })();

    // ---------------------------
    // Utils
    // ---------------------------
    function escapeHtml(str){
      return String(str).replace(/[&<>"'`=\/]/g, s => ({
        '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','`':'&#96;','=':'&#61;','/':'&#47;'
      }[s]));
    }
  </script>
</body>
</html>
