<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CyberBrew ‚Äî BeerFinder</title>

  <!-- Leaflet + Icons -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

  <style>
    /* ====== RESET & THEME ====== */
    *{margin:0;padding:0;box-sizing:border-box}
    body{
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
      color:#fff;
      min-height:100vh;
    }
    a{color:inherit;text-decoration:none}

    /* ====== HEADER / NAV ====== */
    .cyber-header{
      background: linear-gradient(90deg, #1a1a2e, #16213e, #0f3460);
      border-bottom: 2px solid #00ffff;
      box-shadow: 0 0 20px rgba(0,255,255,.3);
      padding:1rem 2rem; position:sticky; top:0; z-index:1000;
    }
    .cyber-nav{display:flex;justify-content:space-between;align-items:center;gap:1rem;flex-wrap:wrap}
    .logo{display:flex;align-items:center;gap:1rem}
    .logo-icon{
      width:50px;height:50px;border-radius:50%;display:flex;align-items:center;justify-content:center;
      background: linear-gradient(45deg, #00ffff, #ff00ff);
      font-size:1.5rem; animation:glow 2s infinite alternate;
    }
    @keyframes glow {from{box-shadow:0 0 10px #00ffff} to{box-shadow:0 0 20px #00ffff,0 0 30px #00ffff}}
    .logo-text{
      font-size:2rem;font-weight:bold;background:linear-gradient(45deg,#00ffff,#ff00ff);
      -webkit-background-clip:text;-webkit-text-fill-color:transparent; text-shadow:0 0 10px rgba(0,255,255,.5);
    }
    .nav-links{display:flex;gap:.6rem;flex-wrap:wrap}
    .nav-link{
      padding:.5rem 1rem;border-radius:6px;display:flex;align-items:center;gap:.5rem;transition:.2s;
    }
    .nav-link:hover{background:rgba(0,255,255,.2);transform:translateY(-2px)}
    .nav-link.active{background:rgba(0,255,255,.3);box-shadow:0 0 15px rgba(0,255,255,.5)}

    /* ====== LAYOUT & CARDS ====== */
    .cyber-container{max-width:1200px;margin:0 auto;padding:1.2rem}
    .cyber-card{
      background: rgba(30, 30, 45, 0.9);
      border: 1px solid rgba(0, 255, 255, 0.3);
      border-radius: 10px; padding: 1.2rem; margin-bottom: 1rem;
    }
    .cyber-title{font-size:1.2rem;margin-bottom:.8rem;color:#00ffff}

    /* ====== FILTERS ====== */
    .filters{display:flex;gap:.6rem;flex-wrap:wrap;align-items:center}
    .filter-input{
      background:rgba(10,10,20,.7); color:#fff; border:1px solid #00ffff; border-radius:6px;
      padding:.6rem .7rem; min-width:200px;
    }
    .range-group{display:flex;align-items:center;gap:.5rem}
    .range-group input[type=range]{width:160px}
    .status{font-size:.9rem;color:#aee;min-height:1.2rem;margin-top:.3rem}

    /* ====== BUTTONS ====== */
    .cyber-btn{
      background: linear-gradient(45deg, #00ffff, #0088ff); color:#000; border:none; border-radius:8px;
      padding:.6rem .9rem; cursor:pointer; font-weight:600; transition:.15s; display:inline-flex; gap:.5rem; align-items:center;
    }
    .cyber-btn:hover{transform:translateY(-1px);box-shadow:0 6px 16px rgba(0,255,255,.25)}
    .cyber-btn-secondary{background:linear-gradient(45deg,#9b9bff,#6f6fff);color:#fff}
    .cyber-btn-danger{background:linear-gradient(45deg,#ff0000,#880000);color:#fff}
    .ghost{background:transparent;border:1px solid #00ffff;color:#00ffff}

    /* ====== MAP & GRID ====== */
    #map{height:500px;border-radius:10px;border:1px solid #00ffff;margin-bottom:1rem}
    .grid-container{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:1rem}
    .pub-card,.beer-card{background:rgba(30,30,45,.9);border:1px solid rgba(0,255,255,.3);border-radius:10px;padding:1rem;transition:.2s}
    .pub-card:hover,.beer-card:hover{transform:translateY(-5px);box-shadow:0 10px 25px rgba(0,255,255,.3);border-color:#00ffff}
    .card-image{width:100%;height:180px;object-fit:cover;border-radius:6px;margin-bottom:.8rem;border:1px solid rgba(255,255,255,.1)}
    .card-title{color:#00ffff;font-size:1.1rem;margin-bottom:.3rem}
    .card-text{color:#ccc;margin-bottom:.6rem;font-size:.95rem}
    .rating{display:flex;align-items:center;gap:.45rem;margin-bottom:.6rem}
    .stars{color:#ffd700}
    .votes{color:#00ffff;font-weight:bold}
    .pill{display:inline-block;border:1px solid rgba(0,255,255,.35);border-radius:999px;padding:.1rem .5rem;margin:.1rem .2rem 0 0;font-size:.75rem;color:#aee}

    /* ====== TROPHIES ====== */
    .trophies-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:1rem}
    .trophy-card{
      background:linear-gradient(45deg,#ffd700,#ffa500); color:#000; border-radius:10px; padding:1rem;
      display:flex;align-items:center;gap:1rem; animation:pulse 2s infinite;
    }
    @keyframes pulse{0%{box-shadow:0 0 10px rgba(255,215,0,.5)}50%{box-shadow:0 0 20px rgba(255,215,0,.8)}100%{box-shadow:0 0 10px rgba(255,215,0,.5)}}
    .trophy-icon{font-size:2rem}

    /* ====== FORMS & MODALS ====== */
    .form-group{margin-bottom:1rem}
    .form-label{display:block;margin-bottom:.35rem;color:#00ffff}
    .form-input,.form-textarea,.form-select{
      width:100%; padding:.7rem; background:rgba(10,10,20,.7); border:1px solid #00ffff; border-radius:6px; color:#fff;
    }
    .form-textarea{min-height:100px;resize:vertical}
    .upload-area{
      border:2px dashed #00ffff;border-radius:6px;padding:1.2rem;text-align:center;cursor:pointer;transition:.2s
    }
    .upload-area:hover{background:rgba(0,255,255,.1)}
    .modal{
      display:none; position:fixed; inset:0; background:rgba(0,0,0,.8); z-index:1000; align-items:center; justify-content:center;
    }
    .modal.open{display:flex}
    .modal-content{
      background: linear-gradient(135deg, #1a1a2e, #16213e);
      border: 2px solid #00ffff;border-radius:10px;padding:1.2rem;width:90%;max-width:600px;max-height:90vh;overflow:auto;position:relative;
      box-shadow:0 0 30px rgba(0,255,255,.5);
    }
    .close-modal{position:absolute;top:.7rem;right:.7rem;background:none;border:none;color:#fff;font-size:1.5rem;cursor:pointer}
    .admin-actions{display:flex;gap:.5rem;margin-top:.7rem}
    .admin-btn{padding:.35rem .8rem;border:none;border-radius:6px;cursor:pointer;font-size:.85rem}

    /* ====== FOOTER ====== */
    .cyber-footer{background: linear-gradient(90deg, #0f0c29, #302b63);text-align:center;padding:1.2rem;border-top:2px solid #00ffff;margin-top:2rem}

    @media (max-width: 768px){
      .filter-input{min-width:unset;width:100%}
      .filters{flex-direction:column;align-items:stretch}
    }
  </style>
</head>
<body>
  <!-- ====== HEADER ====== -->
  <header class="cyber-header">
    <nav class="cyber-nav">
      <div class="logo">
        <div class="logo-icon"><i class="fas fa-beer"></i></div>
        <div class="logo-text">CyberBrew</div>
      </div>
      <div class="nav-links">
        <a href="#" class="nav-link active" data-view="map"><i class="fas fa-map-marked-alt"></i>Carte</a>
        <a href="#" class="nav-link" data-view="beers"><i class="fas fa-beer"></i>Bi√®res</a>
        <a href="#" class="nav-link" data-view="pubs"><i class="fas fa-glass-martini"></i>Pubs</a>
        <a href="#" class="nav-link" data-view="trophies"><i class="fas fa-trophy"></i>Troph√©es</a>
        <a href="#" class="nav-link" data-view="admin"><i class="fas fa-cog"></i>Admin</a>
      </div>
    </nav>
  </header>

  <div class="cyber-container">
    <!-- ====== FILTER BAR ====== -->
    <div class="cyber-card" role="region" aria-label="Filtres de recherche">
      <h2 class="cyber-title">Filtres de Recherche</h2>
      <div class="filters">
        <input id="beerFilter" class="filter-input" type="text" placeholder="Rechercher une bi√®re.">
        <input id="pubFilter" class="filter-input" type="text" placeholder="Rechercher un pub.">

        <select id="locationFilter" class="filter-input" title="Mode de localisation">
          <option value="nearby">√Ä proximit√©</option>
          <option value="all">Tous les lieux</option>
        </select>

        <div class="range-group">
          <label for="radiusRange">Rayon:</label>
          <strong><span id="radiusVal">2.0</span> km</strong>
          <input id="radiusRange" type="range" min="0.5" max="10" step="0.5" value="2">
        </div>

        <button id="btnLocate" class="cyber-btn ghost" title="Me localiser">üìç Localiser</button>
        <button id="btnResetLoc" class="cyber-btn ghost" title="Effacer la localisation">R√©initialiser</button>

        <span style="flex:1"></span>

        <button id="addBeerBtn" class="cyber-btn"><i class="fas fa-plus"></i>Ajouter Bi√®re</button>
        <button id="addPubBtn" class="cyber-btn cyber-btn-secondary"><i class="fas fa-plus"></i>Ajouter Pub</button>
      </div>
      <div id="status" class="status" aria-live="polite"></div>
    </div>

    <!-- ====== MAP VIEW ====== -->
    <div id="mapView">
      <div id="map" aria-label="Carte des pubs"></div>

      <div class="cyber-card">
        <h2 class="cyber-title">Pubs √† Proximit√©</h2>
        <div id="nearbyGrid" class="grid-container"></div>
      </div>
    </div>

    <!-- ====== BEERS VIEW ====== -->
    <div id="beersView" style="display:none">
      <div class="cyber-card">
        <h2 class="cyber-title">Bi√®res Populaires</h2>
        <div class="grid-container">
          <div class="beer-card">
            <img class="card-image" src="https://placehold.co/300x200/0f3460/eee?text=IPA+Cyber" alt="IPA Cyber">
            <h3 class="card-title">IPA Cyber</h3>
            <p class="card-text">Brasserie TechBrew ‚Äî 6.5% ABV</p>
            <div class="rating"><div class="stars"><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star-half-alt"></i></div><span class="votes">124 votes</span></div>
            <div class="admin-actions">
              <button class="admin-btn cyber-btn"><i class="fas fa-edit"></i> Modifier</button>
              <button class="admin-btn cyber-btn-danger"><i class="fas fa-trash"></i> Supprimer</button>
            </div>
          </div>
          <div class="beer-card">
            <img class="card-image" src="https://placehold.co/300x200/16213e/eee?text=Quantum+Stout" alt="Quantum Stout">
            <h3 class="card-title">Quantum Stout</h3>
            <p class="card-text">Brasserie MetaBrew ‚Äî 8.0% ABV</p>
            <div class="rating"><div class="stars"><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="far fa-star"></i></div><span class="votes">78 votes</span></div>
            <div class="admin-actions">
              <button class="admin-btn cyber-btn"><i class="fas fa-edit"></i> Modifier</button>
              <button class="admin-btn cyber-btn-danger"><i class="fas fa-trash"></i> Supprimer</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ====== PUBS VIEW (ALL) ====== -->
    <div id="pubsView" style="display:none">
      <div class="cyber-card">
        <h2 class="cyber-title">Tous les Pubs</h2>
        <div id="allPubsGrid" class="grid-container"></div>
      </div>
    </div>

    <!-- ====== TROPHIES VIEW ====== -->
    <div id="trophiesView" style="display:none">
      <div class="cyber-card">
        <h2 class="cyber-title">Derniers Troph√©es</h2>
        <div class="trophies-grid">
          <div class="trophy-card"><div class="trophy-icon"><i class="fas fa-trophy"></i></div><div><h3>Premi√®re Bi√®re Ajout√©e</h3><p>beer_ninja ‚Äî 15/01/2024</p></div></div>
          <div class="trophy-card"><div class="trophy-icon"><i class="fas fa-trophy"></i></div><div><h3>Explorateur de Pubs</h3><p>travel_hops ‚Äî 13/01/2024</p></div></div>
          <div class="trophy-card"><div class="trophy-icon"><i class="fas fa-trophy"></i></div><div><h3>Communaut√© Active</h3><p>vote_master ‚Äî 12/01/2024</p></div></div>
        </div>
      </div>
    </div>

    <!-- ====== ADMIN VIEW ====== -->
    <div id="adminView" style="display:none">
      <div class="cyber-card">
        <h2 class="cyber-title">Panneau d'Administration</h2>
        <div class="grid-container">
          <div class="cyber-card">
            <h3 class="card-title">Validation des Bi√®res</h3>
            <p class="card-text">2 nouvelles bi√®res en attente de validation</p>
            <button class="cyber-btn" onclick="console.log('Voir les validations bi√®res')">Voir les validations</button>
          </div>
          <div class="cyber-card">
            <h3 class="card-title">Validation des Pubs</h3>
            <p class="card-text">1 nouveau pub en attente de validation</p>
            <button class="cyber-btn" onclick="console.log('Voir les validations pubs')">Voir les validations</button>
          </div>
          <div class="cyber-card">
            <h3 class="card-title">Statistiques</h3>
            <p class="card-text">Nombre total de bi√®res: 156</p>
            <p class="card-text">Nombre total de pubs: 89</p>
            <p class="card-text">Nombre d'utilisateurs: 2 341</p>
            <p class="card-text">Nombre de commentaires: 1 204</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ====== MODAL: ADD BEER ====== -->
  <div id="addBeerModal" class="modal" aria-hidden="true">
    <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="titleAddBeer">
      <button class="close-modal" data-close>&times;</button>
      <h2 id="titleAddBeer" class="cyber-title">Ajouter une Nouvelle Bi√®re</h2>
      <form id="beerForm">
        <div class="form-group"><label class="form-label">Nom de la Bi√®re</label><input class="form-input" required></div>
        <div class="form-group"><label class="form-label">Brasserie</label><input class="form-input" required></div>
        <div class="form-group">
          <label class="form-label">Type de Bi√®re</label>
          <select class="form-select">
            <option>IPA</option><option>Lager</option><option>Stout</option><option>Pilsner</option><option>Wheat Beer</option><option>Porter</option><option>Sour Beer</option>
          </select>
        </div>
        <div class="form-group"><label class="form-label">Description</label><textarea class="form-textarea" placeholder="D√©crivez les ar√¥mes, la texture et les saveurs."></textarea></div>
        <div class="form-group"><label class="form-label">Votre Commentaire</label><textarea class="form-textarea" placeholder="Votre avis personnel sur cette bi√®re."></textarea></div>
        <div class="form-group">
          <label class="form-label">Photo de la Bi√®re</label>
          <div class="upload-area"><i class="fas fa-cloud-upload-alt" style="font-size:2rem;color:#00ffff;margin-bottom:.6rem;"></i><p>Cliquez ou glissez une image ici</p></div>
        </div>
        <button type="submit" class="cyber-btn" style="width:100%"><i class="fas fa-plus"></i>Ajouter la Bi√®re</button>
      </form>
    </div>
  </div>

  <!-- ====== MODAL: ADD PUB ====== -->
  <div id="addPubModal" class="modal" aria-hidden="true">
    <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="titleAddPub">
      <button class="close-modal" data-close>&times;</button>
      <h2 id="titleAddPub" class="cyber-title">Ajouter un Nouveau Pub</h2>
      <form id="pubForm">
        <div class="form-group"><label class="form-label">Nom du Pub</label><input class="form-input" required></div>
        <div class="form-group"><label class="form-label">Adresse</label><input class="form-input" required></div>
        <div class="form-group"><label class="form-label">Description</label><textarea class="form-textarea" placeholder="D√©crivez l'ambiance, les sp√©cialit√©s."></textarea></div>
        <div class="form-group">
          <label class="form-label">Photo du Pub</label>
          <div class="upload-area"><i class="fas fa-cloud-upload-alt" style="font-size:2rem;color:#00ffff;margin-bottom:.6rem;"></i><p>Cliquez ou glissez une image ici</p></div>
        </div>
        <button type="submit" class="cyber-btn" style="width:100%"><i class="fas fa-plus"></i>Ajouter le Pub</button>
      </form>
    </div>
  </div>

  <footer class="cyber-footer">
    <p>¬© 2025 CyberBrew ‚Äî La Communaut√© des Bi√®res</p>
    <p>Version d√©mo statique (prochaine √©tape : Supabase)</p>
  </footer>

  <!-- ====== SCRIPTS ====== -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    // =========================
    // Donn√©es d√©mo (rempla√ßables via Supabase plus tard)
    // =========================
    const PUBS = [
      { id:1, name:"Le Cyber Bar", city:"Paris", lat:48.8566, lng:2.3522, img:"https://placehold.co/600x360/1a1a2e/eee?text=Le+Cyber+Bar", rating:4.7, tags:["craft","ipa"], desc:"Sp√©cialit√©: Bi√®res artisanales cyberpunk" },
      { id:2, name:"Neon Brew", city:"Lyon", lat:45.7640, lng:4.8357, img:"https://placehold.co/600x360/16213e/eee?text=Neon+Brew", rating:4.3, tags:["local","retro"], desc:"Ambiance r√©tro-futuriste et bi√®res locales" },
      { id:3, name:"Quantum Tap", city:"Marseille", lat:43.2965, lng:5.3698, img:"https://placehold.co/600x360/0f3460/eee?text=Quantum+Tap", rating:4.9, tags:["brewpub","lager"], desc:"Plus de 50 bi√®res artisanales disponibles" },
      { id:4, name:"Holo Bar", city:"Lille", lat:50.6292, lng:3.0573, img:"https://placehold.co/600x360/0f3460/eee?text=Holo+Bar", rating:4.2, tags:["holo","future"], desc:"Ambiance futuriste avec projections holographiques" },
      { id:5, name:"Paname Brewing", city:"Paris 19", lat:48.8867, lng:2.3738, img:"https://placehold.co/600x360/1a1a2e/eee?text=Paname+Brewing", rating:4.5, tags:["canal","terrasse"], desc:"Brewpub sur canal ‚Äî vue au top" },
      { id:6, name:"Brewdog Paris", city:"Paris 2", lat:48.8673, lng:2.3429, img:"https://placehold.co/600x360/1a1a2e/eee?text=Brewdog", rating:4.4, tags:["craft","burger"], desc:"Large choix IPA & snacks" },
      { id:7, name:"La Capsule", city:"Paris 10", lat:48.8757, lng:2.3570, img:"https://placehold.co/600x360/1a1a2e/eee?text=La+Capsule", rating:4.6, tags:["belge","trappiste"], desc:"S√©lection belge & trappistes" },
      { id:8, name:"Mikkeller Bar", city:"Paris 9", lat:48.8765, lng:2.3361, img:"https://placehold.co/600x360/1a1a2e/eee?text=Mikkeller", rating:4.4, tags:["sour","craft"], desc:"Acidul√©es & √©ditions limit√©es" },
    ];

    // =========================
    // State & Helpers
    // =========================
    const LS = {
      RADIUS: 'bf.radiusKm',
      MODE: 'bf.mode',     // 'nearby' | 'all'
      LOC: 'bf.loc',       // {lat,lng,ts}
    };
    const els = {
      mapView: document.getElementById('mapView'),
      beersView: document.getElementById('beersView'),
      pubsView: document.getElementById('pubsView'),
      trophiesView: document.getElementById('trophiesView'),
      adminView: document.getElementById('adminView'),

      status: document.getElementById('status'),
      locationFilter: document.getElementById('locationFilter'),
      radius: document.getElementById('radiusRange'),
      radiusVal: document.getElementById('radiusVal'),
      btnLocate: document.getElementById('btnLocate'),
      btnResetLoc: document.getElementById('btnResetLoc'),
      nearbyGrid: document.getElementById('nearbyGrid'),
      allPubsGrid: document.getElementById('allPubsGrid'),
      beerFilter: document.getElementById('beerFilter'),
      pubFilter: document.getElementById('pubFilter'),
    };

    function setStatus(html){ els.status.innerHTML = html || ''; }
    function escapeHtml(s){return String(s).replace(/[&<>"'`=\/]/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','`':'&#96;','=':'&#61;','/':'&#47;'}[c]))}
    function km(m){return (m/1000).toFixed(2) + ' km'}

    // =========================
    // Map (Leaflet)
    // =========================
    const map = L.map('map').setView([48.8566, 2.3522], 12); // Paris par d√©faut
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'&copy; OpenStreetMap'}).addTo(map);
    const layerPubs = L.layerGroup().addTo(map);
    let userMarker = null, userCircle = null;

    function markerForPub(pub){
      return L.marker([pub.lat, pub.lng]).bindPopup(`
        <div style="color:#000">
          <strong>${escapeHtml(pub.name)}</strong><br/>
          <span>${escapeHtml(pub.city)}</span><br/>
          <small>${escapeHtml(pub.desc)}</small><br/>
          ${pub.tags.map(t=>`<span style="border:1px solid #0bf;padding:0 4px;border-radius:999px;margin-right:4px">${escapeHtml(t)}</span>`).join('')}
        </div>
      `);
    }

    function renderMarkers(pubs){
      layerPubs.clearLayers();
      pubs.forEach(p=> markerForPub(p).addTo(layerPubs));
    }
    renderMarkers(PUBS);

    function applyUserLocation(lat,lng,accuracy=50){
      if(userMarker){ map.removeLayer(userMarker); userMarker=null; }
      if(userCircle){ map.removeLayer(userCircle); userCircle=null; }
      userMarker = L.marker([lat,lng],{title:'Votre position'}).addTo(map).bindPopup('Vous √™tes ici');
      userCircle = L.circle([lat,lng],{radius: Math.max(accuracy,20), color:'#42b883', fillColor:'#42b883', fillOpacity:.15}).addTo(map);
    }

    function saveLoc(lat,lng){ localStorage.setItem(LS.LOC, JSON.stringify({lat,lng,ts:Date.now()})); }
    function loadLoc(){
      try{ const raw = localStorage.getItem(LS.LOC); if(!raw) return null; const o = JSON.parse(raw); if(o && typeof o.lat==='number' && typeof o.lng==='number') return o; }catch(e){}
      return null;
    }

    // =========================
    // Nearby Filtering
    // =========================
    function distanceMeters(a,b){ return L.latLng(a.lat,a.lng).distanceTo(L.latLng(b.lat,b.lng)); }

    function computeNearby(userLoc, radiusKm, mode){
      const radM = radiusKm*1000;
      const enriched = PUBS.map(p => ({...p, distance: userLoc ? distanceMeters({lat:p.lat,lng:p.lng}, userLoc) : null}));
      let list = enriched;
      if(mode === 'nearby' && userLoc){
        list = enriched.filter(p => p.distance !== null && p.distance <= radM);
      }
      if(userLoc){
        list.sort((a,b) => (a.distance??Infinity) - (b.distance??Infinity));
      }else{
        list.sort((a,b)=>a.name.localeCompare(b.name));
      }
      return list;
    }

    function renderNearbyGrid(items){
      const root = els.nearbyGrid; root.innerHTML = '';
      if(items.length===0){
        root.innerHTML = `<div class="pub-card"><p class="card-text">Aucun r√©sultat dans ce rayon.</p></div>`;
        return;
      }
      for(const p of items){
        const dist = p.distance!=null ? `<div class="votes">${km(p.distance)}</div>` : '';
        const tags = p.tags.map(t=>`<span class="pill">${escapeHtml(t)}</span>`).join(' ');
        const el = document.createElement('div');
        el.className = 'pub-card';
        el.innerHTML = `
          <img class="card-image" src="${escapeHtml(p.img)}" alt="${escapeHtml(p.name)}">
          <h3 class="card-title">${escapeHtml(p.name)}</h3>
          <p class="card-text">${escapeHtml(p.city)} ‚Äî ${escapeHtml(p.desc)}</p>
          <div class="rating"><div class="stars"><i class="fas fa-star"></i> ${p.rating.toFixed(1)}</div>${dist}</div>
          <div>${tags}</div>
          <div class="admin-actions">
            <button class="admin-btn cyber-btn" onclick="console.log('edit pub', ${p.id})"><i class="fas fa-edit"></i> Modifier</button>
            <button class="admin-btn cyber-btn-danger" onclick="console.log('delete pub', ${p.id})"><i class="fas fa-trash"></i> Supprimer</button>
          </div>
        `;
        el.addEventListener('click', () => {
          map.setView([p.lat,p.lng], Math.max(map.getZoom(), 14), {animate:true});
        });
        root.appendChild(el);
      }
    }

    function renderAllPubsGrid(items){
      const root = els.allPubsGrid; root.innerHTML='';
      for(const p of items){
        const tags = p.tags.map(t=>`<span class="pill">${escapeHtml(t)}</span>`).join(' ');
        const el = document.createElement('div');
        el.className = 'pub-card';
        el.innerHTML = `
          <img class="card-image" src="${escapeHtml(p.img)}" alt="${escapeHtml(p.name)}">
          <h3 class="card-title">${escapeHtml(p.name)}</h3>
          <p class="card-text">${escapeHtml(p.city)} ‚Äî ${escapeHtml(p.desc)}</p>
          <div class="rating"><div class="stars"><i class="fas fa-star"></i> ${p.rating.toFixed(1)}</div></div>
          <div>${tags}</div>
        `;
        root.appendChild(el);
      }
    }

    function getUserLocCurrent(){
      if(userMarker){ const ll = userMarker.getLatLng(); return {lat: ll.lat, lng: ll.lng}; }
      return loadLoc();
    }

    // =========================
    // UI Handlers
    // =========================
    function syncAndRender(){
      const radiusKm = parseFloat(els.radius.value) || 2;
      els.radiusVal.textContent = radiusKm.toFixed(1);
      const mode = els.locationFilter.value;
      localStorage.setItem(LS.RADIUS, String(radiusKm));
      localStorage.setItem(LS.MODE, mode);

      const userLoc = getUserLocCurrent();
      const items = computeNearby(userLoc, radiusKm, mode);

      // Si mode nearby sans localisation -> message
      if(mode==='nearby' && !userLoc){
        setStatus('‚ÑπÔ∏è Activez ‚Äúüìç Localiser‚Äù pour filtrer √† proximit√©.');
      }else{
        setStatus('');
      }

      // Marqueurs : si nearby + userLoc => n‚Äôafficher que ceux dans le rayon
      if(mode==='nearby' && userLoc){
        const radM = radiusKm*1000;
        renderMarkers(PUBS.filter(p => distanceMeters({lat:p.lat,lng:p.lng}, userLoc) <= radM));
      }else{
        renderMarkers(PUBS);
      }

      renderNearbyGrid(items);
      renderAllPubsGrid(PUBS);
    }

    els.locationFilter.addEventListener('change', syncAndRender);
    els.radius.addEventListener('input', syncAndRender);
    els.btnResetLoc.addEventListener('click', () => {
      localStorage.removeItem(LS.LOC);
      if(userMarker){ map.removeLayer(userMarker); userMarker=null; }
      if(userCircle){ map.removeLayer(userCircle); userCircle=null; }
      setStatus('üîÑ Localisation effac√©e. Mode carte g√©n√©rale.');
      syncAndRender();
    });

    els.btnLocate.addEventListener('click', () => {
      if(!('geolocation' in navigator)){
        setStatus('‚ùå G√©olocalisation non support√©e par ce navigateur.');
        return;
      }
      setStatus('üìç Localisation en cours‚Ä¶');
      navigator.geolocation.getCurrentPosition(
        pos => {
          const { latitude:lat, longitude:lng, accuracy } = pos.coords;
          applyUserLocation(lat,lng,accuracy);
          saveLoc(lat,lng);
          map.setView([lat,lng], 14);
          setStatus(`‚úÖ Localis√© (¬±${Math.round(accuracy||50)} m).`);
          syncAndRender();
        },
        err => {
          if(err.code===err.PERMISSION_DENIED) setStatus('üö´ Permission refus√©e.');
          else if(err.code===err.POSITION_UNAVAILABLE) setStatus('‚ö†Ô∏è Position indisponible.');
          else if(err.code===err.TIMEOUT) setStatus('‚è≥ D√©lai d√©pass√©.');
          else setStatus('‚ùå Erreur inconnue de g√©olocalisation.');
        },
        { enableHighAccuracy:true, timeout:10000, maximumAge:0 }
      );
    });

    // =========================
    // Navigation entre vues
    // =========================
    document.querySelectorAll('.nav-link').forEach(link=>{
      link.addEventListener('click', e=>{
        e.preventDefault();
        document.querySelectorAll('.nav-link').forEach(l=>l.classList.remove('active'));
        link.classList.add('active');
        const view = link.getAttribute('data-view');
        ['map','beers','pubs','trophies','admin'].forEach(v=>{
          const el = document.getElementById(v+'View');
          if(el) el.style.display = (v===view)?'block':'none';
        });
        if(view==='map'){ setTimeout(()=>map.invalidateSize(), 150); }
      });
    });

    // =========================
    // Modals (Add Beer / Add Pub)
    // =========================
    function openModal(id){ document.getElementById(id).classList.add('open'); document.getElementById(id).setAttribute('aria-hidden','false'); }
    function closeModal(el){ el.closest('.modal').classList.remove('open'); el.closest('.modal').setAttribute('aria-hidden','true'); }

    document.getElementById('addBeerBtn').addEventListener('click', ()=>openModal('addBeerModal'));
    document.getElementById('addPubBtn').addEventListener('click', ()=>openModal('addPubModal'));
    document.querySelectorAll('[data-close]').forEach(btn=>btn.addEventListener('click', e=>closeModal(e.target)));
    document.getElementById('beerForm').addEventListener('submit', e=>{e.preventDefault(); alert('Bi√®re ajout√©e (d√©mo).'); closeModal(e.target);});
    document.getElementById('pubForm').addEventListener('submit', e=>{e.preventDefault(); alert('Pub ajout√© (d√©mo).'); closeModal(e.target);});

    // =========================
    // Boot: charger pr√©f√©rences & dessiner
    // =========================
    (function boot(){
      const savedRadius = parseFloat(localStorage.getItem(LS.RADIUS) || '2');
      const savedMode = localStorage.getItem(LS.MODE) || 'nearby';
      els.radius.value = isFinite(savedRadius) ? savedRadius : 2;
      els.radiusVal.textContent = parseFloat(els.radius.value).toFixed(1);
      els.locationFilter.value = (savedMode==='all' || savedMode==='nearby') ? savedMode : 'nearby';

      const saved = loadLoc();
      if(saved){ applyUserLocation(saved.lat, saved.lng, 50); }
      renderAllPubsGrid(PUBS);
      syncAndRender();
    })();
  </script>
</body>
</html>
